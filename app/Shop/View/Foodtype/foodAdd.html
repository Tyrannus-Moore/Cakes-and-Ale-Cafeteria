<extend name="Public/base" />
<block name="main-content">
    <div class="page-content" style="padding-top: 50px">
        <!--主题-->
        <div class="page-header">
            <h1>您当前操作
                <small>
                    <i class="ace-icon fa fa-angle-double-right"></i>添加菜品
                </small>
            </h1>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <form class="form-horizontal ajaxFormFo" name="admin_list_add" method="post" action="{:U('foodAdd')}">
                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 菜品类型：  </label>
                        <div class="col-sm-6" style="display: flex;">
                            <select name="type" class="form-control type" style="width:100px" required>
                                <option value="1">普通菜品</option>
                                <option value="2">周餐菜品</option>
                            </select>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group taocan" style="display: none">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 商品信息： </label>
                        <div class="col-sm-9">
                            <table class="table table-striped table-bordered table-hover" style="width:1050px;" id="dynamic-table">
                                <thead>
                                <tr>
                                    <th class="hidden-xs" style="text-align: center">周/餐</th>
                                    <th class="hidden-xs" style="text-align: center">早餐</th>
                                    <th class="hidden-xs" style="text-align: center">午餐</th>
                                    <th class="hidden-xs" style="text-align: center">晚餐</th>
                                </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周一</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="11" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>11))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="12" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>12))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="13" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>13))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周二</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="21" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>21))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="22" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>22))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="23" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>23))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周三</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="31" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>31))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="32" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>32))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="33" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>33))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周四</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="41" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>41))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="42" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>42))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="43" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>43))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周五</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="51" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>51))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="52" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>52))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="53" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>53))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周六</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="61" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>61))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="62" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>62))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="63" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>63))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="hidden-xs" style="text-align: center">周日</td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="71" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>71))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="72" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>72))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                        <td class="hidden-xs">
                                            <input type="hidden" name="ids[]" value="">
                                            <p style="float: left">无</p>
                                            <a class="btn btn-minier btn-success" style="float: right" id="73" href="javascript:;" onclick="iframek('{:U('choose',array('nid'=>73))}','选择')" title="选择" >
                                                选择
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="space-4"></div>
                   <!--  <div class="form-group mode">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 配送方式：  </label>
                        <div class="checkbox">
                            <ul>
                                <label>
                                    <input class="ace ace-checkbox-2" name="status[]" value="1" type="checkbox" checked>
                                    <span class="lbl">配送</span>
                                </label>
                                <label>
                                    <input class="ace ace-checkbox-2" name="status[]" value="2" type="checkbox" checked>
                                    <span class="lbl">自提</span>
                                </label>
                            </ul>
                            
                        </div>
                    </div> -->
                    <div class="form-group" id="pic_list">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1">菜品图片： </label>
                        <div class="col-sm-10">
                            <a href="javascript:;" class="file" title="点击选择所要上传的图片">
                                <input type="file" name="img" id="file0" multiple="multiple" required/>
                                选择上传文件
                            </a>&nbsp;&nbsp;
                            <a href="javascript:;" onclick="return backpic('<if condition="$infos.url eq ''">__PUBLIC__/img/no_img.jpg<else/>__ROOT__{$infos.url}</if>');" title="还原修改前的图片" class="file">
                            撤销上传
                            </a>
                            <div><img src="<if condition="$infos.url neq ''">__ROOT__{$infos.url}<else/>__PUBLIC__/img/no_img.jpg</if>" height="70" id="img0" ></div>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*图片比例218×218px</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 菜品名称：  </label>
                        <div class="col-sm-6">
                            <input type="text" name="dishes_name" placeholder="菜品名称 限制20字" maxlength="20" class="col-xs-10 col-sm-5" required/>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 档口名称：  </label>
                        <div class="col-sm-6" style="display: flex;">
                            <select name="stall" class="form-control stall" style="width:200px" required>
                            </select>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 分类名称：  </label>
                        <div class="col-sm-6" style="display: flex;">
                            <select name="dishes_cate_id" class="form-control" style="width:100px" required>
                                <option value="">请选择</option>
                                <foreach name="dishes_cate_list" item="v">
                                    <option value="{$v['dishes_cate_id']}">{$v['cat_name']}</option>
                                </foreach>
                            </select>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 菜品价格：  </label>
                        <div class="col-sm-6">
                            <input type="text" name="price" placeholder="菜品价格" class="col-xs-10 col-sm-5" required  onkeyup="this.value=this.value.replace(/^(\d*\.?\d{0,2}).*/,'$1')" />
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 热量值：  </label>
                        <div class="col-sm-6">
                            <input type="number" name="hot" step="1" min="1" placeholder="热量值" class="col-xs-10 col-sm-5" required/>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 库存：  </label>
                        <div class="col-sm-6">
                            <input type="number" name="num" step="1" min="1" placeholder="库存" class="col-xs-10 col-sm-5" required/>
                            <span class="lbl col-xs-12 col-sm-7"><span class="red">*</span></span>
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 活动类型：  </label>
                        <div class="col-sm-6" style="display: flex;">
                            <select name="statue" class="form-control" style="width:100px" id="statue" required>
                                <option value="1">普通菜品</option>
                                <option value="2">精选推荐</option>
                                <option value="3">限时折扣</option>
                            </select>
                            <span class="lbl col-xs-1"><span class="red">*</span></span>
                            <div style="display: none;" class="discount">
                                <input type="number" name="discount" style="width: 50px;" step="0.1" min="0.1" value="10" max="10" placeholder="折扣"  />折
                            </div>
                        </div>

                    </div>
                    <div class="space-4"></div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 上/下架： </label>
                        <div class="col-sm-3">
                            <input type="radio" name="state" value="1" checked />上架
                            <input type="radio" name="state" value="2"/>下架
                        </div>
                    </div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 菜品描述： </label>
                        <div class="col-sm-6">
                            <script src="__PUBLIC__/ueditor/ueditor.config.js" type="text/javascript"></script>
                            <script src="__PUBLIC__/ueditor/ueditor.all.js" type="text/javascript"></script>
                            <textarea name="content" rows="100%" style="width:100%;height:350px;" id="myEditor"></textarea>
                            <script type="text/javascript">
                                var editor = new UE.ui.Editor();
                                editor.render("myEditor");
                            </script>
                        </div>
                    </div>
                    <div class="space-4"></div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label no-padding-right" for="form-field-1"> 排序：  </label>
                        <div class="col-sm-7">
                            <input type="number" min="1" name="sort" placeholder="排序" class="col-xs-10 col-sm-5" required/>
                        </div>
                    </div>
                    <div class="space-4"></div>
                    <div class="clearfix form-actions">
                        <div class="col-md-offset-3 col-md-9">
                            <button class="btn btn-info" type="submit">
                                <i class="ace-icon fa fa-check bigger-110"></i>
                                保存
                            </button>
                            &nbsp; &nbsp; &nbsp;
                            <a href="javascript:history.back(-1)">
                                <i class="ace-icon fa fa-undo bigger-110"></i> 返回
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div><!-- /.page-content -->
    <script>
        //iframe框架
        function iframek(url,title){
            layer.open({
                type: 2,
                title: title,
                maxmin: true,
                area: ['1200px', '700px'],
                content: url,
            });
        };
        //菜品切换
        $('#statue').change(function(){
            var statue = $(this).val();
            if(statue == 2){
                $(".discount").css('display','block');//表示设置为可用
            }else{
                $(".discount").css('display','none');//表示设置为可用
            }
        })
        $(function () {
            var val =  $(".type").val();
            if(val == 1){
                // $('.mode').show();
                $.ajax({
                    url:"{:U('type')}",
                    data:{
                        type:1
                    },
                    success:function(data) {
                        addList(data);
                    }
                });
            }else{
                // $('.mode').hide();
                $.ajax({
                    url:"{:U('type')}",
                    data:{
                        type:2
                    },
                    success:function(data) {
                        addList(data);
                    }
                });
            }
        });
        $(".type").change(function () {
            var val = $(this).val();
            if(val == 1){
                // $('.mode').show();
                $(".taocan").hide();
                $.ajax({
                    url:"{:U('type')}",
                    data:{
                        type:1
                    },
                    success:function(data) {
                        addList(data);
                    }
                });
            }else{
                // $('.mode').hide();
                $(".taocan").show();
                $.ajax({
                    url:"{:U('type')}",
                    data:{
                        type:2
                    },
                    success:function(data) {
                        addList(data);
                    }
                });
            }
        });
        function addList(data) {
            var str = '';
            $.each(data,function(i){
                str += '<option value="'+data[i]['stall_id']+'">'+data[i]['stall_name']+'</option>';
            });
            $(".stall").empty();
            $(".stall").append(str);
        };
        $(function(){
            $('.ajaxFormFo').ajaxForm({
                beforeSubmit: BeforeFormF,
                success: complete2, // 这是提交后的方法
                dataType: 'json'
            });
        });
        var  zzf;
        //提交前验证
        function BeforeFormF() {
            var type = $(".type").val();
            if(type == 2){
                var arr = [];
                var ids = $('input[name="ids[]"]');
                for(var i = 0; i < ids.length; i ++){
                    if($(ids[i]).val() != ''){
                        arr.push($(ids[i]).val())
                    }
                }
                if(arr.length == 0){
                    layer.alert('周餐必须添加菜品！', {icon: 5});
                    return false;
                }
            }else{
                // var ids=[]; 

                // $('input[name="status[]"]:checked').each(function(){
                //     ids.push($(this).val);
                // });
                // if(ids.length<1){
                //     layer.alert('请选择配送方式', {icon: 5});
                //     return false;
                // }
            }
            zzf  = layer.load(1, {shade: [0.8, '#393D49']});
        }
        //失败不跳转
        function complete2(data) {
            if (data.status == 1) {
                layer.alert(data.info, {icon: 6}, function (index) {
                    layer.close(index);
                    layer.close(zzf);
                    window.location.href = data.url;
                });
            } else {
                layer.alert(data.info, {icon: 5}, function (index) {
                    layer.close(index);
                    layer.close(zzf);
                });
            }
        }
    </script>
</block>